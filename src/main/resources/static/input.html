<!DOCTYPE html>
<script type = 'text/javascript' src = 'https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.1.2/handlebars.js'> </script>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>로또 구매</title>
</head>
<body>
<script id = 'initial_template' type='text/x-handlebars-template'></script>
<div>
    <form action="#" id="budgetInputForm" name="budgetInputForm">
        <div>
            구입금액 입력
            <input id="budget" name="budget" onkeydown="javascript: return event.keyCode == 69
                       || event.keyCode == 46 || event.keyCode == 43 || event.keyCode == 45
                       ? false : true" type="number">
            </br>
            <button id="budgetButton" onclick="inputBudget()" type="button"> 입력</button>
        </div>
    </form>
    <div id="manualLottoContainer" style="display: none">
        <div id="lottoNoContainers">
            <h1> 수동 로또 번호 입력 </h1>
            <input id="plusBtn" onclick=addBox() type="button" value="+"><br/>
            <div id="lottoNoContainer" name="lottoNoContainer" style="display: none">
                로또 번호
                <input id="lottoNo" name="lottoNo" type="text"></input>
                <input name="minusBtn" onclick="removeBox(this)" type="button" value="-">
            </div>
        </div>
        </br>
        <input id="purchaseBtn" onclick="buyLotto()" type="button" value="구입"></input>
    </div>
    <div id="lottoReceipt" style="display: none">
        </br></br>
    </div>
    <input type="hidden" id="lotto_price" value="{{lotto_price}}"/>
</div>
<script>
    var budget = -1;
    var maxManualCount = -1;
    var countOfManualInputBox = 0;
    var lotto_price = parseInt(document.getElementById('lotto_price').value)
    var lotto_result

    function inputBudget() {
        budget = document.getElementsByName('budget')[0].value;

        if(budget <= lotto_price) {
                alert('돈이 부족해서 로또를 살 수 없습니다.');
        }
        else {
                maxManualCount = parseInt(budget / lotto_price)
                console.log('success : maxManualCount changed to ' + maxManualCount);
                document.getElementById("budget").readOnly = true;
                document.getElementById("budgetButton").style.display = "none";
                document.getElementById("manualLottoContainer").style.display = "block";
        }
    }

    function addBox() {
        console.log('add : ' + countOfManualInputBox +' / ' +maxManualCount);
        if(countOfManualInputBox < maxManualCount){
            var div = document.createElement('div');

            div.innerHTML = document.getElementById('lottoNoContainer').innerHTML;
            document.getElementById('lottoNoContainers').appendChild(div);
            countOfManualInputBox += 1;
        }
        else{
            alert("구입 하신 금액으로 더 이상 구매할 수 없습니다.");
        }
    }

    function removeBox(obj) {
        if(countOfManualInputBox > 0){
            document.getElementById('lottoNoContainers').removeChild(obj.parentNode);
            countOfManualInputBox -= 1;
        }
        else{
            alert("더 이상 삭제할 수 없습니다.");
        }
    }

    function buyLotto() {
        var lotto_purchase_info = new Object()

        var manualLotto = document.getElementsByName('lottoNo')
        lotto_purchase_info.budget = budget
        lotto_purchase_info.manualCount = manualLotto.length - 1

        var lottoArray = [];

        for (var i = 1; i < manualLotto.length; i++) {
            lottoArray.push(manualLotto[i].value);
        }
        lotto_purchase_info.manualLottos = lottoArray
        lotto_purchase_info.autoCount = maxManualCount - manualLotto.length + 1

        console.log(lotto_purchase_info)

        $.ajax({
            url:"lottoPurchase",
            type:"POST",
            traditional:true,
            data:lotto_purchase_info,
            dataType:'json',
            error:function(request,status,error){
                alert(JSON.parse(request.responseText).message);
                console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            },
            success:function(data){
                console.log("success : buyLotto");
                lotto_result = data
                showLotto()
            }
        })
    }

    function showLotto() {
        alert("구입 완료!");
        document.getElementById("lottoReceipt").style.display = "block";
        document.getElementById("plusBtn").style.display = "none";
        document.getElementById("purchaseBtn").style.display = "none";

        var minusBtn = document.getElementsByName("minusBtn");
        for(var i=0; i<minusBtn.length; i++){
            minusBtn[i].style.display = "none";
        }

        var lottoNoInputs = document.getElementsByName("lottoNo");
        for(var i=0; i<lottoNoInputs.length; i++){
            lottoNoInputs[i].readOnly = true;
        }

        var summary = document.createElement('h3');
        summary.innerHTML = '수동으로 ' + lotto_result.data.manualCount + '개 자동으로 ' 
            + lotto_result.data.autoCount + '개를 구입했습니다.'
        document.getElementById('lottoReceipt').appendChild(summary);
        lottos = lotto_result.data.manualLottos.concat(lotto_result.data.autoLottos)
        for(var i=0; i<lottos.length; i++){
            console.log(lottos[i]);
            var p = document.createElement('p');
            p.innerHTML = lottos[i];
            document.getElementById('lottoReceipt').appendChild(p);
        }
    }

</script>
</body>
</html>
